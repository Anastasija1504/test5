<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>–¢—Ä–µ–Ω–∞–∂–µ—Ä –ø–∞–º‚Äô—è—Ç—ñ: –ú–æ—Ä—Å—å–∫–∏–π –±—ñ–π</title>
<style>
  :root{
    --bg:#f4f6f8;
    --card:#ffffff;
    --ink:#0f172a;
    --muted:#64748b;
    --line:#e2e8f0;
    --blue:#0a5fa5;
    --ok:#16a34a;
    --bad:#ef4444;
    --shadow: 0 10px 30px rgba(15, 23, 42, .08);
    --radius:14px;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  body{margin:0;background:var(--bg);color:var(--ink)}
  .topbar{
    height:48px;background:#111827;color:#fff;
    display:flex;align-items:center;justify-content:space-between;
    padding:0 14px;gap:10px;
  }
  .topbar .left{display:flex;align-items:center;gap:10px}
  .badge{font-size:12px;opacity:.9}
  .pill{
    font-size:12px;border:1px solid rgba(255,255,255,.18);
    padding:6px 10px;border-radius:999px;opacity:.95
  }
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .card{
    background:var(--card);border:1px solid var(--line);
    border-radius:var(--radius);box-shadow:var(--shadow);
    padding:18px;
  }
  h1,h2{margin:0 0 10px 0}
  h1{font-size:18px}
  h2{font-size:16px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:14px;flex-wrap:wrap}
  .col{flex:1;min-width:280px}
  .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
  label{font-size:13px;color:var(--muted)}
  input{
    height:44px;border:1px solid var(--line);border-radius:12px;
    padding:0 12px;font-size:15px;outline:none;background:#fff;
  }
  input:focus{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(147,197,253,.35)}
  .btn{
    height:46px;border:0;border-radius:12px;
    background:var(--blue);color:#fff;font-weight:700;
    cursor:pointer;padding:0 14px;font-size:15px;
  }
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:#0f172a}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .stageTitle{display:flex;align-items:flex-end;justify-content:space-between;gap:10px;margin-bottom:10px}
  .stageTitle .hint{font-size:13px;color:var(--muted)}
  .bigGrid{display:flex;justify-content:center}
  canvas{max-width:100%;height:auto;border-radius:12px}
  .countdown{
    display:flex;align-items:center;justify-content:center;
    width:54px;height:54px;border-radius:14px;
    background:#0f172a;color:#fff;font-size:18px;font-weight:800;
  }
  .options{
    display:grid;grid-template-columns:repeat(2,minmax(0,1fr));
    gap:12px;margin-top:12px;
  }
  @media (min-width:860px){
    .options{grid-template-columns:repeat(4,minmax(0,1fr))}
  }
  .opt{
    border:1px solid var(--line);border-radius:14px;
    background:#fff;padding:10px;cursor:pointer;
    transition:transform .05s ease, box-shadow .2s ease, border-color .2s ease;
    box-shadow:0 6px 18px rgba(15,23,42,.06);
    display:flex;flex-direction:column;gap:8px;
    user-select:none;
    touch-action:manipulation;
  }
  .opt:active{transform:scale(.99)}
  .opt .tag{font-size:12px;color:var(--muted);display:flex;justify-content:space-between}
  .opt.good{border-color:rgba(22,163,74,.7);box-shadow:0 0 0 3px rgba(22,163,74,.15), 0 10px 24px rgba(15,23,42,.08)}
  .opt.bad{border-color:rgba(239,68,68,.7);box-shadow:0 0 0 3px rgba(239,68,68,.15), 0 10px 24px rgba(15,23,42,.08)}
  .opt.disabled{pointer-events:none;opacity:.85}
  .footerLine{
    display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
    margin-top:14px;padding-top:12px;border-top:1px dashed var(--line)
  }
  .kpi{display:flex;gap:10px;flex-wrap:wrap}
  .kpi .box{
    padding:8px 10px;border:1px solid var(--line);border-radius:12px;background:#fff;
    font-size:13px;color:var(--muted)
  }
  .kpi b{color:var(--ink)}
  .center{text-align:center}
  .hidden{display:none !important}
  .toast{
    margin-top:10px;font-size:13px;color:var(--muted)
  }
  /* Confetti canvas */
  #confetti{
    position:fixed;inset:0;pointer-events:none;z-index:50;
  }
</style>
</head>
<body>
  <div class="topbar">
    <div class="left">
      <div class="pill">üö¢ –¢—Ä–µ–Ω–∞–∂–µ—Ä</div>
      <div class="badge muted" id="userBadge"></div>
    </div>
    <div class="left" style="gap:8px">
      <div class="pill">–ë–∞–ª–∏: <b id="scoreTop">0</b></div>
      <div class="pill">–†—ñ–≤–µ–Ω—å: <b id="levelTop">0</b>/10</div>
    </div>
  </div>

  <canvas id="confetti"></canvas>

  <div class="wrap">
    <!-- START -->
    <div class="card" id="screenStart">
      <div class="row">
        <div class="col">
          <h1>–¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è –ø–∞–º‚Äô—è—Ç—ñ ‚Äú–ú–æ—Ä—Å—å–∫–∏–π –±—ñ–π‚Äù</h1>
          <div class="muted">
            –¢–æ–±—ñ –ø–æ–∫–∞–∑—É—é—Ç—å —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∞–±–ª—ñ–≤ <b>–Ω–∞ 8 —Å–µ–∫—É–Ω–¥</b>. –ü–æ—Ç—ñ–º ‚Äî 4 –≤–∞—Ä—ñ–∞–Ω—Ç–∏.
            –û–±–µ—Ä–∏ —Ç–æ–π, —è–∫–∏–π –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Ç–æ–º—É, —â–æ —Ç–∏ –∑–∞–ø–∞–º‚Äô—è—Ç–∞–ª–∞.
            –ß–∞—Å –Ω–∞ –≤–∏–±—ñ—Ä <b>–Ω–µ –æ–±–º–µ–∂–µ–Ω–∏–π</b>.
          </div>

          <div class="field">
            <label for="name">–Ü–º‚Äô—è</label>
            <input id="name" type="text" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ê–Ω–∞—Å—Ç–∞—Å—ñ—è" autocomplete="name" />
          </div>

          <div class="field">
            <label for="email">–ü–æ—à—Ç–∞</label>
            <input id="email" type="email" placeholder="name@example.com" autocomplete="email" />
          </div>

          <button class="btn" id="btnStart">–ü–æ—á–∞—Ç–∏ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è</button>

          <div class="toast muted">
            –ó–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å ‚Äî <b>10 –±–∞–ª—ñ–≤</b>. –ù–∞–≤—ñ—Ç—å —è–∫—â–æ –ø–æ–º–∏–ª–∏–ª–∞—Å—è ‚Äî —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è –ø—Ä–æ–¥–æ–≤–∂—É—î—Ç—å—Å—è.
          </div>
        </div>

        <div class="col">
          <div class="card" style="box-shadow:none;border-style:dashed">
            <h2>–Ø–∫ —Ü–µ –≤–∏–≥–ª—è–¥–∞—Ç–∏–º–µ</h2>
            <div class="muted" style="margin-bottom:10px">–ü—Ä–∏–∫–ª–∞–¥ –ø–æ–ª—è —Ç–∞ –∫–æ—Ä–∞–±–ª—ñ–≤:</div>
            <div class="bigGrid">
              <canvas id="preview" width="520" height="520" aria-label="preview"></canvas>
            </div>
            <div class="muted" style="margin-top:10px;font-size:13px">
              –ü—ñ—Å–ª—è 8 —Å–µ–∫—É–Ω–¥ –∑‚Äô—è–≤–ª—è—Ç—å—Å—è 4 –º—ñ–Ω—ñ-–ø–æ–ª—è –¥–ª—è –≤–∏–±–æ—Ä—É.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- GAME -->
    <div class="card hidden" id="screenGame">
      <div class="stageTitle">
        <div>
          <h1 id="stageHeader">–ó–∞–ø–∞–º‚Äô—è—Ç–∞–π —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∞–±–ª—ñ–≤</h1>
          <div class="hint" id="stageHint">–¢–∞–π–º–µ—Ä —ñ–¥–µ‚Ä¶</div>
        </div>
        <div class="countdown" id="countdown">8</div>
      </div>

      <div class="bigGrid">
        <canvas id="main" width="560" height="560" aria-label="main grid"></canvas>
      </div>

      <div class="options hidden" id="options"></div>

      <div class="footerLine">
        <div class="kpi">
          <div class="box">–ë–∞–ª–∏: <b id="score">0</b></div>
          <div class="box">–†—ñ–≤–µ–Ω—å: <b id="level">1</b>/10</div>
          <div class="box">–ß–∞—Å: <b id="time">00:00</b></div>
        </div>
        <button class="btn secondary" id="btnRestart" title="–ü–æ—á–∞—Ç–∏ –∑–∞–Ω–æ–≤–æ">–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫</button>
      </div>
    </div>

    <!-- FINISH -->
    <div class="card hidden" id="screenFinish">
      <div class="center">
        <h1>–ì–æ—Ç–æ–≤–æ! üéâ</h1>
        <div class="muted" style="margin-top:6px">–¢–≤–æ—ó —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏:</div>

        <div class="row" style="justify-content:center;margin-top:14px">
          <div class="card" style="min-width:260px;box-shadow:none">
            <div class="muted">–ë–∞–ª–∏</div>
            <div style="font-size:34px;font-weight:900" id="finalScore">0</div>
          </div>
          <div class="card" style="min-width:260px;box-shadow:none">
            <div class="muted">–ß–∞—Å –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è</div>
            <div style="font-size:34px;font-weight:900" id="finalTime">00:00</div>
          </div>
        </div>

        <div style="margin-top:14px">
          <button class="btn" id="btnAgain">–ü—Ä–æ–π—Ç–∏ —â–µ —Ä–∞–∑</button>
        </div>

        <div class="muted" style="margin-top:10px;font-size:13px">
          (–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ñ—ñ–∫—Å—É—é—Ç—å—Å—è.)
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø TELEGRAM
   ========================= */
const TG_BOT_TOKEN = "8566496742:AAEv2Wm6o_c2inMNWRtxsqPMH9WrV72iuB0";
const TG_CHAT_ID   = "1350269784";

/* =========================
   –ì–õ–û–ë–ê–õ–¨–ù–Ü –°–¢–ê–ù–ò
   ========================= */
const TOTAL_LEVELS = 10;
const MEMO_SECONDS = 8;
const GRID_N = 8;

let userName = "";
let userEmail = "";

let level = 0;
let score = 0;
let startTs = 0;
let timerInterval = null;

let memoTimer = null;
let memoLeft = MEMO_SECONDS;

let correctLayout = null;     // {ships:[{x,y,len,dir}], n:GRID_N}
let optionsLayouts = [];      // 4 layouts
let accepting = false;

/* =========================
   DOM
   ========================= */
const screenStart  = document.getElementById("screenStart");
const screenGame   = document.getElementById("screenGame");
const screenFinish = document.getElementById("screenFinish");

const inpName  = document.getElementById("name");
const inpEmail = document.getElementById("email");

const btnStart   = document.getElementById("btnStart");
const btnRestart = document.getElementById("btnRestart");
const btnAgain   = document.getElementById("btnAgain");

const userBadge = document.getElementById("userBadge");

const scoreTop = document.getElementById("scoreTop");
const levelTop = document.getElementById("levelTop");

const stageHeader = document.getElementById("stageHeader");
const stageHint   = document.getElementById("stageHint");
const countdownEl = document.getElementById("countdown");

const scoreEl = document.getElementById("score");
const levelEl = document.getElementById("level");
const timeEl  = document.getElementById("time");

const finalScoreEl = document.getElementById("finalScore");
const finalTimeEl  = document.getElementById("finalTime");

const previewCanvas = document.getElementById("preview");
const mainCanvas    = document.getElementById("main");
const optionsWrap   = document.getElementById("options");

const confettiCanvas = document.getElementById("confetti");

/* =========================
   –î–û–ü–û–ú–Ü–ñ–ù–Ü
   ========================= */
function pad2(n){ return String(n).padStart(2,"0"); }
function fmtTime(ms){
  const s = Math.max(0, Math.floor(ms/1000));
  const mm = Math.floor(s/60);
  const ss = s%60;
  return `${pad2(mm)}:${pad2(ss)}`;
}
function now(){ return Date.now(); }
function randInt(a,b){ // [a,b]
  return a + Math.floor(Math.random()*(b-a+1));
}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function deepCopy(obj){ return JSON.parse(JSON.stringify(obj)); }

/* =========================
   –õ–ï–ô–ê–£–¢ –ö–û–†–ê–ë–õ–Ü–í
   ========================= */
function shipCells(ship){
  const cells = [];
  for(let i=0;i<ship.len;i++){
    const cx = ship.x + (ship.dir===0 ? i : 0);
    const cy = ship.y + (ship.dir===1 ? i : 0);
    cells.push(`${cx},${cy}`);
  }
  return cells;
}

function layoutKey(layout){
  // –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π –∫–ª—é—á –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è
  const ships = layout.ships.slice().map(s => ({
    x:s.x,y:s.y,len:s.len,dir:s.dir
  }));
  ships.sort((a,b)=> (a.len-b.len) || (a.dir-b.dir) || (a.x-b.x) || (a.y-b.y));
  return JSON.stringify({n:layout.n, ships});
}

function overlaps(ship, takenSet){
  const cells = shipCells(ship);
  for(const c of cells){
    if(takenSet.has(c)) return true;
    const [x,y] = c.split(",").map(Number);
    if(x<0 || y<0 || x>=GRID_N || y>=GRID_N) return true;
  }
  return false;
}

function addToTaken(ship, takenSet){
  for(const c of shipCells(ship)) takenSet.add(c);
}

function genShipsForLevel(lv){
  // –ø–ª–∞–≤–Ω–µ —É—Å–∫–ª–∞–¥–Ω–µ–Ω–Ω—è: –±—ñ–ª—å—à–µ –∫–æ—Ä–∞–±–ª—ñ–≤ –∑ —Ä–æ—Å—Ç–æ–º —Ä—ñ–≤–Ω—è
  // 1-3: 2 –∫–æ—Ä–∞–±–ª—ñ (4,3)
  // 4-6: 3 –∫–æ—Ä–∞–±–ª—ñ (4,3,2)
  // 7-10: 4 –∫–æ—Ä–∞–±–ª—ñ (4,3,2,2)
  let sizes = [4,3,2,2];
  let count = (lv<=3)?2 : (lv<=6)?3 : 4;
  return sizes.slice(0,count);
}

function generateLayout(lv){
  const sizes = genShipsForLevel(lv);
  const ships = [];
  const taken = new Set();
  for(const len of sizes){
    let placed = false;
    for(let tries=0; tries<500 && !placed; tries++){
      const dir = Math.random()<0.5 ? 0 : 1;
      const maxX = dir===0 ? GRID_N-len : GRID_N-1;
      const maxY = dir===1 ? GRID_N-len : GRID_N-1;
      const x = randInt(0,maxX);
      const y = randInt(0,maxY);
      const ship = {x,y,len,dir};
      if(!overlaps(ship, taken)){
        ships.push(ship);
        addToTaken(ship, taken);
        placed = true;
      }
    }
    if(!placed){
      // fallback: —è–∫—â–æ —Ä–∞–ø—Ç–æ–º –Ω–µ –≤–∏–π—à–ª–æ ‚Äî –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä—É—î–º–æ –ø–æ–≤–Ω—ñ—Å—Ç—é
      return generateLayout(lv);
    }
  }
  return {n:GRID_N, ships};
}

function mutateLayout(base, lv){
  // —Å—Ç–≤–æ—Ä—é—î–º–æ —Å—Ö–æ–∂—É, –∞–ª–µ —ñ–Ω—à—É ‚Äî –∑–º—ñ–Ω—é—î–º–æ 1 –∫–æ—Ä–∞–±–µ–ª—å (–∑—Å—É–≤/–ø–æ–≤–æ—Ä–æ—Ç)
  const out = deepCopy(base);
  const idx = randInt(0, out.ships.length-1);
  const s = out.ships[idx];

  // —Å–ø—Ä–æ–±–∏ –∑—Ä–æ–±–∏—Ç–∏ —ñ–Ω—à–∏–π —Å—Ç–∞–Ω
  for(let tries=0; tries<250; tries++){
    const candidate = deepCopy(out);
    const ship = candidate.ships[idx];

    const action = randInt(1,3);
    if(action===1){
      // –∑—Å—É–≤
      ship.x = randInt(0, GRID_N-1);
      ship.y = randInt(0, GRID_N-1);
    }else if(action===2){
      // –ø–æ–≤–æ—Ä–æ—Ç
      ship.dir = ship.dir===0?1:0;
    }else{
      // –ø–æ–≤–æ—Ä–æ—Ç + –∑—Å—É–≤
      ship.dir = ship.dir===0?1:0;
      ship.x = randInt(0, GRID_N-1);
      ship.y = randInt(0, GRID_N-1);
    }

    // –ø—ñ–¥—Ä—ñ–≤–Ω—è—Ç–∏ –≤ –º–µ–∂—ñ
    if(ship.dir===0) ship.x = Math.min(ship.x, GRID_N-ship.len);
    if(ship.dir===1) ship.y = Math.min(ship.y, GRID_N-ship.len);
    ship.x = Math.max(0, ship.x);
    ship.y = Math.max(0, ship.y);

    // –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞–∫–ª–∞–¥–∞–Ω—å
    const taken = new Set();
    let ok = true;
    for(const sh of candidate.ships){
      if(overlaps(sh, taken)){ ok=false; break; }
      addToTaken(sh, taken);
    }
    if(!ok) continue;

    // –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞, —â–æ –Ω–µ —ñ–¥–µ–Ω—Ç–∏—á–Ω–∏–π –±–∞–∑–æ–≤–æ–º—É
    if(layoutKey(candidate) !== layoutKey(base)) return candidate;
  }

  // fallback: –ø–æ–≤–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è
  let fresh = generateLayout(lv);
  if(layoutKey(fresh) === layoutKey(base)) fresh = generateLayout(lv);
  return fresh;
}

function buildOptions(correct, lv){
  const keys = new Set([layoutKey(correct)]);
  const opts = [correct];
  while(opts.length < 4){
    const m = mutateLayout(correct, lv);
    const k = layoutKey(m);
    if(!keys.has(k)){
      keys.add(k);
      opts.push(m);
    }
  }
  return shuffle(opts);
}

/* =========================
   –ú–ê–õ–Æ–í–ê–ù–ù–Ø
   ========================= */
function drawGrid(ctx, w, h, n){
  ctx.clearRect(0,0,w,h);
  ctx.save();

  // background
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,w,h);

  // frame
  const pad = Math.round(Math.min(w,h)*0.06);
  const x0 = pad, y0 = pad;
  const size = Math.min(w,h) - pad*2;

  // outer border
  ctx.strokeStyle = "#0a5fa5";
  ctx.lineWidth = Math.max(2, Math.round(size*0.006));
  ctx.strokeRect(x0,y0,size,size);

  // inner grid
  ctx.strokeStyle = "#cbd5e1";
  ctx.lineWidth = 1;
  for(let i=1;i<n;i++){
    const t = i*size/n;
    // vertical
    ctx.beginPath();
    ctx.moveTo(x0+t, y0);
    ctx.lineTo(x0+t, y0+size);
    ctx.stroke();
    // horizontal
    ctx.beginPath();
    ctx.moveTo(x0, y0+t);
    ctx.lineTo(x0+size, y0+t);
    ctx.stroke();
  }

  ctx.restore();
  return {x0,y0,size,cell:size/n};
}

function drawShip(ctx, geom, ship){
  const {x0,y0,cell} = geom;
  const x = x0 + ship.x*cell;
  const y = y0 + ship.y*cell;
  const w = (ship.dir===0 ? ship.len : 1)*cell;
  const h = (ship.dir===1 ? ship.len : 1)*cell;

  // –∫–æ—Ä–ø—É—Å (—Å—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è)
  const r = Math.max(6, Math.round(cell*0.22));
  ctx.save();
  ctx.translate(x,y);

  // shadow
  ctx.fillStyle = "rgba(15,23,42,.12)";
  roundRect(ctx, 3, 4, w, h, r);
  ctx.fill();

  // body
  ctx.fillStyle = "#111827";
  roundRect(ctx, 0, 0, w, h, r);
  ctx.fill();

  // light panel
  ctx.fillStyle = "#f8fafc";
  const p = Math.max(3, Math.round(cell*0.12));
  roundRect(ctx, p, p, Math.max(2, w-2*p), Math.max(2, h-2*p), Math.max(4, r-4));
  ctx.fill();

  // ‚Äú–¥–µ—Ç–∞–ª—ñ‚Äù
  ctx.strokeStyle = "#111827";
  ctx.lineWidth = Math.max(1, Math.round(cell*0.06));
  ctx.beginPath();
  if(ship.dir===0){
    // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ñ ‚Äú–≤—ñ–∫–Ω–∞‚Äù
    const cy = h/2;
    ctx.moveTo(p*1.7, cy);
    ctx.lineTo(w-p*1.7, cy);
  }else{
    const cx = w/2;
    ctx.moveTo(cx, p*1.7);
    ctx.lineTo(cx, h-p*1.7);
  }
  ctx.stroke();

  ctx.restore();
}

function roundRect(ctx, x,y,w,h,r){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
}

function renderLayout(canvas, layout){
  const ctx = canvas.getContext("2d");
  const geom = drawGrid(ctx, canvas.width, canvas.height, layout.n);
  for(const ship of layout.ships){
    drawShip(ctx, geom, ship);
  }
}

/* =========================
   –õ–û–ì–Ü–ö–ê –ì–†–ò
   ========================= */
function setTop(){
  scoreTop.textContent = String(score);
  levelTop.textContent = String(level);
  scoreEl.textContent = String(score);
  levelEl.textContent = String(level);
}

function show(el){ el.classList.remove("hidden"); }
function hide(el){ el.classList.add("hidden"); }

function startRun(){
  userName = (inpName.value || "").trim();
  userEmail = (inpEmail.value || "").trim();

  if(!userName){
    inpName.focus();
    inpName.style.borderColor = "rgba(239,68,68,.6)";
    setTimeout(()=>inpName.style.borderColor="", 800);
    return;
  }
  if(!userEmail || !userEmail.includes("@")){
    inpEmail.focus();
    inpEmail.style.borderColor = "rgba(239,68,68,.6)";
    setTimeout(()=>inpEmail.style.borderColor="", 800);
    return;
  }

  userBadge.textContent = `${userName} ‚Ä¢ ${userEmail}`;
  level = 0;
  score = 0;
  startTs = now();

  hide(screenStart);
  hide(screenFinish);
  show(screenGame);

  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    timeEl.textContent = fmtTime(now()-startTs);
  }, 250);

  nextLevel();
}

function restartRun(){
  stopMemoTimer();
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = null;
  startTs = 0;
  level = 0;
  score = 0;

  // UI
  timeEl.textContent = "00:00";
  scoreEl.textContent = "0";
  levelEl.textContent = "0";
  scoreTop.textContent = "0";
  levelTop.textContent = "0";

  // screens
  hide(screenGame);
  hide(screenFinish);
  show(screenStart);

  stopConfetti();
}

function nextLevel(){
  stopMemoTimer();
  level++;
  setTop();
  levelEl.textContent = String(level);
  stageHeader.textContent = "–ó–∞–ø–∞–º‚Äô—è—Ç–∞–π —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∞–±–ª—ñ–≤";
  stageHint.textContent = "–ü—ñ—Å–ª—è 8 —Å–µ–∫—É–Ω–¥ –∑‚Äô—è–≤–ª—è—Ç—å—Å—è 4 –≤–∞—Ä—ñ–∞–Ω—Ç–∏ ‚Äî –æ–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π.";
  countdownEl.textContent = String(MEMO_SECONDS);

  // –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –ª–µ–π–∞—É—Ç—ñ–≤
  correctLayout = generateLayout(level);
  optionsLayouts = buildOptions(correctLayout, level);

  // –ø–æ–∫–∞–∑ –∑–∞–ø–∞–º‚Äô—è—Ç–æ–≤—É–≤–∞–Ω–Ω—è
  hide(optionsWrap);
  renderLayout(mainCanvas, correctLayout);

  memoLeft = MEMO_SECONDS;
  show(countdownEl);

  memoTimer = setInterval(()=>{
    memoLeft--;
    countdownEl.textContent = String(memoLeft);
    if(memoLeft <= 0){
      stopMemoTimer();
      showOptions();
    }
  }, 1000);
}

function stopMemoTimer(){
  if(memoTimer){
    clearInterval(memoTimer);
    memoTimer = null;
  }
}

function showOptions(){
  stageHeader.textContent = "–û–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç";
  stageHint.textContent = "–ß–∞—Å –Ω–∞ –≤–∏–±—ñ—Ä –Ω–µ –æ–±–º–µ–∂–µ–Ω–∏–π.";
  hide(countdownEl);

  // –æ—á–∏—Å—Ç–∏—Ç–∏ —ñ –Ω–∞–º–∞–ª—é–≤–∞—Ç–∏ 4 –≤–∞—Ä—ñ–∞–Ω—Ç–∏
  optionsWrap.innerHTML = "";
  optionsWrap.classList.remove("hidden");

  const correctK = layoutKey(correctLayout);

  optionsLayouts.forEach((layout, idx)=>{
    const k = layoutKey(layout);
    const opt = document.createElement("div");
    opt.className = "opt";
    opt.setAttribute("role","button");
    opt.setAttribute("tabindex","0");

    const top = document.createElement("div");
    top.className = "tag";
    top.innerHTML = `<span>–í–∞—Ä—ñ–∞–Ω—Ç ${idx+1}</span><span class="muted">tap/click</span>`;

    const c = document.createElement("canvas");
    c.width = 220;
    c.height = 220;

    opt.appendChild(top);
    opt.appendChild(c);

    renderLayout(c, layout);

    const choose = ()=>{
      if(!accepting) return;
      accepting = false;

      // disable all
      [...optionsWrap.querySelectorAll(".opt")].forEach(x=>x.classList.add("disabled"));

      const isCorrect = (k === correctK);
      if(isCorrect){
        score += 10;
        setTop();
        opt.classList.add("good");
      }else{
        opt.classList.add("bad");
        // –ø—ñ–¥—Å–≤—ñ—Ç–∏–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π (—Ç—ñ–ª—å–∫–∏ –±–æ—Ä–¥–µ—Ä–æ–º) ‚Äî –±–µ–∑ —Ç–µ–∫—Å—Ç—É
        [...optionsWrap.querySelectorAll(".opt")].forEach((node, j)=>{
          if(layoutKey(optionsLayouts[j]) === correctK){
            node.classList.add("good");
          }
        });
      }

      setTimeout(()=>{
        if(level >= TOTAL_LEVELS){
          finishRun();
        }else{
          accepting = true;
          nextLevel();
        }
      }, 750);
    };

    opt.addEventListener("click", choose);
    opt.addEventListener("keydown", (e)=>{
      if(e.key==="Enter" || e.key===" "){ e.preventDefault(); choose(); }
    });

    optionsWrap.appendChild(opt);
  });

  accepting = true;
}

function finishRun(){
  stopMemoTimer();
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = null;

  const totalMs = now() - startTs;

  // UI
  finalScoreEl.textContent = String(score);
  finalTimeEl.textContent  = fmtTime(totalMs);

  hide(screenGame);
  show(screenFinish);

  startConfetti();

  // —Ç–∏—Ö–æ –Ω–∞–¥—Å–∏–ª–∞—î–º–æ —É Telegram
  sendToTelegram({
    name: userName,
    email: userEmail,
    score,
    levels: TOTAL_LEVELS,
    time: fmtTime(totalMs),
    ms: totalMs,
    whenISO: new Date().toISOString()
  });
}

/* =========================
   TELEGRAM (–¢–ò–•–û)
   ========================= */
async function sendToTelegram(payload){
  try{
    const text =
`üö¢ –ú–æ—Ä—Å—å–∫–∏–π —Ç—Ä–µ–Ω–∞–∂–µ—Ä ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç
üë§ –Ü–º‚Äô—è: ${payload.name}
‚úâÔ∏è –ü–æ—à—Ç–∞: ${payload.email}
üèÅ –†—ñ–≤–Ω—ñ–≤: ${payload.levels}
‚≠ê –ë–∞–ª–∏: ${payload.score}
‚è± –ß–∞—Å: ${payload.time}
üóì ${payload.whenISO}`;

    const url = `https://api.telegram.org/bot${encodeURIComponent(TG_BOT_TOKEN)}/sendMessage`;
    await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        chat_id: TG_CHAT_ID,
        text,
        disable_web_page_preview: true
      })
    });
  }catch(err){
    // –Ω—ñ—á–æ–≥–æ –Ω–µ –ø–æ–∫–∞–∑—É—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
  }
}

/* =========================
   CONFETTI
   ========================= */
let confettiRAF = null;
let confettiBits = [];

function resizeConfetti(){
  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
  confettiCanvas.width  = Math.floor(window.innerWidth  * dpr);
  confettiCanvas.height = Math.floor(window.innerHeight * dpr);
  confettiCanvas.style.width = window.innerWidth+"px";
  confettiCanvas.style.height = window.innerHeight+"px";
}
window.addEventListener("resize", ()=>{ if(confettiRAF) resizeConfetti(); });

function startConfetti(){
  resizeConfetti();
  const ctx = confettiCanvas.getContext("2d");
  const W = confettiCanvas.width;
  const H = confettiCanvas.height;

  confettiBits = [];
  const count = 260;
  for(let i=0;i<count;i++){
    confettiBits.push({
      x: Math.random()*W,
      y: -Math.random()*H*0.2,
      vx: (Math.random()*2-1) * 1.2,
      vy: 2.2 + Math.random()*3.2,
      w: 6 + Math.random()*10,
      h: 6 + Math.random()*14,
      r: Math.random()*Math.PI,
      vr: (Math.random()*2-1)*0.08,
      a: 0.8 + Math.random()*0.2
    });
  }

  function tick(){
    const W = confettiCanvas.width;
    const H = confettiCanvas.height;
    ctx.clearRect(0,0,W,H);

    for(const p of confettiBits){
      p.x += p.vx;
      p.y += p.vy;
      p.r += p.vr;

      // –ª–µ–≥–∫–∏–π ‚Äú–≤—ñ—Ç–µ—Ä‚Äù
      p.vx += (Math.random()*2-1)*0.02;
      p.vx = Math.max(-2.5, Math.min(2.5, p.vx));

      if(p.y > H+40){
        p.y = -20;
        p.x = Math.random()*W;
      }

      ctx.save();
      ctx.globalAlpha = p.a;
      ctx.translate(p.x,p.y);
      ctx.rotate(p.r);

      // –±–µ–∑ –∑–∞–¥–∞–Ω–∏—Ö –∫–æ–ª—å–æ—Ä—ñ–≤ ‚Äî –±–µ—Ä–µ–º–æ –≤–∏–ø–∞–¥–∫–æ–≤–∏–π –≤—ñ–¥—Ç—ñ–Ω–æ–∫ —á–µ—Ä–µ–∑ hsl
      const hue = (p.x + p.y) % 360;
      ctx.fillStyle = `hsl(${hue} 85% 55%)`;
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);

      ctx.restore();
    }

    confettiRAF = requestAnimationFrame(tick);
  }

  stopConfetti();
  confettiRAF = requestAnimationFrame(tick);
}

function stopConfetti(){
  if(confettiRAF){
    cancelAnimationFrame(confettiRAF);
    confettiRAF = null;
  }
  const ctx = confettiCanvas.getContext("2d");
  ctx && ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
}

/* =========================
   PREVIEW
   ========================= */
function makePreview(){
  const demo = generateLayout(7);
  renderLayout(previewCanvas, demo);
}
makePreview();

/* =========================
   EVENTS
   ========================= */
btnStart.addEventListener("click", startRun);
btnRestart.addEventListener("click", restartRun);
btnAgain.addEventListener("click", ()=>{
  stopConfetti();
  // —Å—Ç–∞—Ä—Ç –æ–¥—Ä–∞–∑—É –∑ —Ç–∏–º–∏ –∂ –¥–∞–Ω–∏–º–∏
  hide(screenFinish);
  show(screenGame);

  level = 0;
  score = 0;
  startTs = now();

  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    timeEl.textContent = fmtTime(now()-startTs);
  }, 250);

  nextLevel();
});

// Enter –Ω–∞ —Ñ–æ—Ä–º—ñ
[inpName, inpEmail].forEach(inp=>{
  inp.addEventListener("keydown",(e)=>{
    if(e.key==="Enter") startRun();
  });
});

// —Å—Ç–∞—Ä—Ç–æ–≤–∏–π –≤–∏–≥–ª—è–¥ –≤–µ—Ä—Ö–Ω—å–æ—ó –ø–∞–Ω–µ–ª—ñ
levelTop.textContent = "0";
scoreTop.textContent = "0";
document.getElementById("level").textContent = "0";
document.getElementById("score").textContent = "0";
</script>
</body>
</html>
